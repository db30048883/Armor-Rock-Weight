<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Armor Rock Gradation</title>
  <link rel="manifest" href="manifest.json" />
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => console.log('SW registered:', reg))
          .catch(err => console.error('SW failed:', err));
      });
    }
    window.addEventListener('beforeunload', (e) => {
      e.preventDefault();
      e.returnValue = '';
    });
  </script>
  <style>
    body { font-family: Arial, sans-serif; background-color: #1e1e1e; color: #f0f0f0; padding: 20px; }
    .container { background: #2c2c2c; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.3); max-width: 500px; margin: auto; }
    h1 { text-align: center; }
    #rockWeight { width: 100%; padding: 16px; font-size: 24px; margin: 0 auto 20px auto; display: block; border-radius: 8px; border: none; background-color: #444; color: white; text-align: right; }
    .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
    .numpad button { padding: 20px; font-size: 24px; border-radius: 10px; border: none; background-color: limegreen; color: white; cursor: pointer; }
    .numpad button:hover { background-color: green; }
    .enter-button { grid-column: span 3; padding: 24px; font-size: 20px; margin-top: 10px; }
    button.action { width: 100%; padding: 14px; margin: 5px 0; background-color: #28a745; color: white; font-size: 16px; border: none; border-radius: 6px; cursor: pointer; }
    #results, #savedLogs, #rockList { margin-top: 20px; }
    pre { background-color: #3a3a3a; padding: 10px; overflow-x: auto; }
    .editable { cursor: pointer; color: #7dd3fc; }
    .edit-input { width: 80px; }
    .log-entry { border-bottom: 1px solid #444; padding: 6px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Armor Rock Gradation</h1>
    <input type="text" id="rockWeight" placeholder="Enter rock weight (lbs)" readonly>
    <div class="numpad" id="numpad"></div>
    <button class="action" onclick="finishLog()">Finish + Save Log</button>
    <details>
      <summary style="background-color: orange; color: white; padding: 14px; margin: 5px 0; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; text-align: center;">More Options</summary>
      <div style="margin-top: 10px;">
        <button class="action" onclick="viewSavedLogs()">View Saved Logs</button>
        <button class="action" onclick="downloadLastLog()">Download Last Log (.txt)</button>
        <button class="action" onclick="downloadCSV()">Export Last Log (.csv)</button>
        <button class="action" onclick="downloadAllLogsTxt()">Export All Logs (.txt)</button>
        <button class="action" onclick="downloadAllLogsCSV()">Export All Logs (.csv)</button>
        <button class="action" onclick="clearAllLogs()">Clear All Logs</button>
        <button class="action" onclick="resetLog()">Reset Log</button>
      </div>
    </details>
    <div id="results"></div>
    <div id="rockList"></div>
    <div id="savedLogs"></div>
  </div>
  <script>
    let rockWeights = JSON.parse(localStorage.getItem('armorRockAutosave') || '[]');
    let currentLog = {};

    const input = document.getElementById('rockWeight');
    const numpad = document.getElementById('numpad');
    let currentEntry = '';

    const buttons = ['1','2','3','4','5','6','7','8','9','.', '0','⌫'];
    buttons.forEach(char => {
      const btn = document.createElement('button');
      btn.textContent = char;
      btn.onclick = () => handleNumpad(char);
      numpad.appendChild(btn);
    });

    const enterBtn = document.createElement('button');
    enterBtn.textContent = 'Enter Weight';
    enterBtn.className = 'numpad button enter-button';
    enterBtn.onclick = () => handleNumpad('ENT');
    numpad.appendChild(enterBtn);

    function handleNumpad(char) {
      if (char === '⌫') {
        currentEntry = currentEntry.slice(0, -1);
      } else if (char === 'ENT') {
        const weight = parseFloat(currentEntry);
        if (!isNaN(weight)) {
          rockWeights.push(weight);
          updateDisplay();
        }
        currentEntry = '';
      } else {
        currentEntry += char;
      }
      input.value = currentEntry;
    }

    function updateDisplay() {
      localStorage.setItem('armorRockAutosave', JSON.stringify(rockWeights));
      const total = rockWeights.length;
      const totalWeight = rockWeights.reduce((sum, val) => sum + val, 0);
      const avgWeight = total > 0 ? (totalWeight / total).toFixed(2) : 0;

      const undersize = rockWeights.filter(w => w < 3500);
      const nearUndersize = rockWeights.filter(w => w >= 3500 && w < 3700);
      const inspec = rockWeights.filter(w => w >= 3700 && w <= 7500);
      const oversize = rockWeights.filter(w => w > 7500 && w <= 8500);
      const outOfSpec = rockWeights.filter(w => w > 8500);

      const oversizeWeight = oversize.reduce((sum, val) => sum + val, 0);
      const oversizePercent = totalWeight > 0 ? ((oversizeWeight / totalWeight) * 100).toFixed(2) : 0;

      const nearUndersizeWeight = nearUndersize.reduce((sum, val) => sum + val, 0);
      const nearUndersizePercent = totalWeight > 0 ? ((nearUndersizeWeight / totalWeight) * 100).toFixed(2) : 0;

      currentLog = {
        timestamp: new Date().toLocaleString(),
        weights: [...rockWeights],
        total,
        totalWeight,
        avgWeight,
        undersize: undersize.length,
        inspec: inspec.length,
        oversizePercent,
        nearUndersizePercent,
        outOfSpec: outOfSpec.length
      };

      document.getElementById('results').innerHTML = `
        <p>Total rocks weighed: ${total}</p>
        <p>Total weight: ${totalWeight.toFixed(2)} lbs</p>
        <p>Average weight: ${avgWeight} lbs (${avgWeight >= 5400 ? "PASS" : "FAIL"})</p>
        <p><strong>Undersize (<3500 lbs):</strong> ${undersize.length}</p>
        <p><strong>Near Undersize % by Weight (3500-3700 lbs, max 3% allowed):</strong> ${nearUndersizePercent}%</p>
        <p><strong>In Spec (3700-7500 lbs):</strong> ${inspec.length}</p>
        <p><strong>Oversize % by Weight (7500-8500 lbs, max 10% allowed):</strong> ${oversizePercent}%</p>
        <p><strong>Out of Spec (>8500 lbs):</strong> ${outOfSpec.length}</p>
      `;

      document.getElementById('rockList').innerHTML = `<p><strong>Rocks Entered (click to edit):</strong></p>${rockWeights.map((w, i) => `
        <div class='log-entry'>
          <span>${i + 1}:</span>
          <input class='edit-input' type='number' value='${w}' onchange='updateWeight(${i}, this.value)' /> lbs
        </div>`).join('')}`;
    }

    function updateWeight(index, value) {
      if (!isNaN(parseFloat(value))) {
        rockWeights[index] = parseFloat(value);
        updateDisplay();
      }
    }

    function finishLog() {
      if (!currentLog.timestamp || rockWeights.length === 0) {
        alert('Add some rocks first!');
        return;
      }
      const logs = JSON.parse(localStorage.getItem('armorRockLogs') || '[]');
      logs.push(currentLog);
      localStorage.setItem('armorRockLogs', JSON.stringify(logs));
      alert('Log saved!');
      rockWeights = [];
      updateDisplay();
    }

    function viewSavedLogs() {
      const logs = JSON.parse(localStorage.getItem('armorRockLogs') || '[]');
      if (logs.length === 0) {
        document.getElementById('savedLogs').innerHTML = '<p>No saved logs found.</p>';
        return;
      }
      const detailed = logs.map((log, idx) => `Log ${idx + 1} — ${log.timestamp}\n  Total: ${log.total} rocks\n  Total Weight: ${log.totalWeight} lbs\n  Avg: ${log.avgWeight} lbs\n  Undersize: ${log.undersize}\n  Near Undersize %: ${log.nearUndersizePercent}\n  In Spec: ${log.inspec}\n  Oversize %: ${log.oversizePercent}\n  Out of Spec: ${log.outOfSpec}\n  Weights: ${log.weights.join(', ')}`).join('\n\n');
      document.getElementById('savedLogs').innerHTML = `
        <h3>All Saved Logs (${logs.length})</h3>
        <pre>${detailed}</pre>
      `;
    }

    function downloadLastLog() {
      const logs = JSON.parse(localStorage.getItem('armorRockLogs') || '[]');
      if (logs.length === 0) {
        alert('No logs available to download.');
        return;
      }
      const log = logs[logs.length - 1];
      const content = `Timestamp: ${log.timestamp}\nTotal Rocks: ${log.total}\nTotal Weight: ${log.totalWeight}\nAverage Weight: ${log.avgWeight}\nUndersize: ${log.undersize}\nNear Undersize %: ${log.nearUndersizePercent}\nIn Spec: ${log.inspec}\nOversize %: ${log.oversizePercent}\nOut of Spec: ${log.outOfSpec}\nWeights: ${log.weights.join(', ')}`;
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `armor_log_${new Date().toISOString().split('T')[0]}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function downloadCSV() {
      const logs = JSON.parse(localStorage.getItem('armorRockLogs') || '[]');
      if (logs.length === 0) {
        alert('No logs to export.');
        return;
      }
      const log = logs[logs.length - 1];
      const header = ['Metric', 'Value'];
      const data = [
        ['Total Rocks', log.total],
        ['Total Weight', log.totalWeight],
        ['Average Weight', log.avgWeight],
        ['Undersize', log.undersize],
        ['Near Undersize %', log.nearUndersizePercent],
        ['In Spec', log.inspec],
        ['Oversize %', log.oversizePercent],
        ['Out of Spec', log.outOfSpec],
        ...log.weights.map((w, i) => [`Rock ${i + 1}`, w])
      ];
      const csv = [header, ...data].map(row => row.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `armor_log_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function downloadAllLogsTxt() {
      const logs = JSON.parse(localStorage.getItem('armorRockLogs') || '[]');
      if (logs.length === 0) {
        alert('No logs available.');
        return;
      }
      const content = logs.map((log, idx) => `Log ${idx + 1} — ${log.timestamp}\nTotal: ${log.total} rocks\nTotal Weight: ${log.totalWeight}\nAverage Weight: ${log.avgWeight}\nUndersize: ${log.undersize}\nNear Undersize %: ${log.nearUndersizePercent}\nIn Spec: ${log.inspec}\nOversize %: ${log.oversizePercent}\nOut of Spec: ${log.outOfSpec}\nWeights: ${log.weights.join(', ')}`).join('\n\n');
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `armor_logs_all_${new Date().toISOString().split('T')[0]}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function downloadAllLogsCSV() {
      const logs = JSON.parse(localStorage.getItem('armorRockLogs') || '[]');
      if (logs.length === 0) {
        alert('No logs available.');
        return;
      }
      let csv = 'Log,Timestamp,Total Rocks,Total Weight,Average Weight,Undersize,Near Undersize %,In Spec,Oversize %,Out of Spec,Rock #,Weight\n';
      logs.forEach((log, idx) => {
        log.weights.forEach((w, i) => {
          csv += `${idx + 1},${log.timestamp},${log.total},${log.totalWeight},${log.avgWeight},${log.undersize},${log.nearUndersizePercent},${log.inspec},${log.oversizePercent},${log.outOfSpec},${i + 1},${w}\n`;
        });
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `armor_logs_all_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function clearAllLogs() {
      if (confirm('Are you sure you want to delete ALL saved logs? This cannot be undone.')) {
        localStorage.removeItem('armorRockLogs');
        document.getElementById('savedLogs').innerHTML = '<p>All logs cleared.</p>';
      }
    }

    function resetLog() {
      if (confirm('Are you sure you want to reset the current log? This cannot be undone.')) {
        rockWeights = [];
        currentEntry = '';
        input.value = '';
        updateDisplay();
      }
    }
  </script>
</body>
</html>
